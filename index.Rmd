---
title: "SB Cities Dashboard"
runtime: shiny_prerendered
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

suppressMessages({
  library(shiny)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(plotly)
  library(lubridate)
  library(scales)
  library(gt)
})

# ---- Safe loader for derived artifacts ----
must_read_rds <- function(path) {
  if (!file.exists(path)) {
    stop("Missing required data file: ", path,
         "\nMake sure you ran data_prep.R and that the file was created.")
  }
  readRDS(path)
}

income_m_q    <- must_read_rds("data/derived/income_medians_quarterly.rds")
income_m_m    <- must_read_rds("data/derived/income_medians_monthly.rds")
lease_q       <- must_read_rds("data/derived/lease_medians_quarterly.rds")
bps_ca        <- must_read_rds("data/derived/bps_ca_filtered.rds")
crime_master  <- must_read_rds("data/derived/crime_nibrs_city_year_master.rds")
acs_times     <- must_read_rds("data/derived/acs_place_timeseries_2010_2023.rds")
acs_compare   <- must_read_rds("data/derived/acs_tenure_age_compare_2012_2022.rds")

CITY_CHOICES <- c("UPLAND","MONTCLAIR","CLAREMONT","REDLANDS","ONTARIO","POMONA")
NAME_MAP <- c(
  "UPLAND"     = "Upland city, California",
  "MONTCLAIR"  = "Montclair city, California",
  "CLAREMONT"  = "Claremont city, California",
  "REDLANDS"   = "Redlands city, California",
  "ONTARIO"    = "Ontario city, California",
  "POMONA"     = "Pomona city, California"
)

# Small theming helper for nice axes
num_axis <- function() scale_y_continuous(labels = label_number(big.mark = ","))
```



```{r, context="setup"}
ui <- navbarPage(
  title = "SB Cities Dashboard",
  id = "nav",
  selected = "Market",
  header = NULL,
  tabPanel(
    "Market",
    sidebarLayout(
      sidebarPanel(
        selectInput("city", "City", choices = CITY_CHOICES, selected = "REDLANDS"),
        helpText("Data are precomputed and load instantly.")
      ),
      mainPanel(
        h4("Median Sale Price (Quarterly)"),
        plotlyOutput("p_income_qtr", height = 380),
        br(),
        h4("Median Sale Price (Monthly)"),
        plotlyOutput("p_income_mo", height = 300)
      )
    )
  ),
  tabPanel(
    "Leases",
    sidebarLayout(
      sidebarPanel(
        selectInput("city_l", "City", choices = CITY_CHOICES, selected = "REDLANDS")
      ),
      mainPanel(
        h4("Median Lease Price (Quarterly)"),
        plotlyOutput("p_lease_qtr", height = 380),
        br(),
        h4("Median Lease DOM (Quarterly)"),
        plotlyOutput("p_lease_dom", height = 280)
      )
    )
  ),
  tabPanel(
    "Permits",
    sidebarLayout(
      sidebarPanel(
        selectInput("city_b", "City", choices = CITY_CHOICES, selected = "REDLANDS")
      ),
      mainPanel(
        h4("Residential Units Permitted (Total) by Year"),
        plotlyOutput("p_bps_total", height = 380),
        br(),
        h4("5+ Units (Multifamily) by Year"),
        plotlyOutput("p_bps_5p", height = 280)
      )
    )
  ),
  tabPanel(
    "Crime",
    sidebarLayout(
      sidebarPanel(
        selectInput("city_c", "City", choices = CITY_CHOICES, selected = "REDLANDS")
      ),
      mainPanel(
        uiOutput("crime_note"),
        plotlyOutput("p_crime_total", height = 380),
        br(),
        plotlyOutput("p_crime_breakout", height = 320)
      )
    )
  ),
  tabPanel(
    "ACS",
    sidebarLayout(
      sidebarPanel(
        selectInput("city_a", "City", choices = CITY_CHOICES, selected = "REDLANDS"),
        helpText("ACS 5-year: tenure & age comparison (2012 vs 2022); timeseries 2010–2023.")
      ),
      mainPanel(
        h4("Tenure & Age Comparison (2012 → 2022)"),
        gt_output("tbl_compare"),
        br(),
        h4("Vacancy Rate, Median HH Income, Population (2010–2023)"),
        plotlyOutput("p_acs_vac", height = 260),
        plotlyOutput("p_acs_inc", height = 260),
        plotlyOutput("p_acs_pop", height = 260)
      )
    )
  )
)

```


```{r, context="server"}
server <- function(input, output, session) {

  # ---- MARKET (Sales) ----
  out_q <- reactive({
    req(input$city)
    income_m_q %>%
      filter(City == input$city) %>%
      mutate(period_label = factor(period, levels = unique(period)))
  }) %>% bindCache(input$city)

  output$p_income_qtr <- renderPlotly({
    d <- out_q()
    p <- ggplot(d, aes(period_label, SP, group = 1)) +
      geom_col() +
      num_axis() + labs(x = NULL, y = "Median SP ($)") +
      theme_minimal(base_size = 12) +
      theme(axis.text.x = element_text(angle = 60, hjust = 1))
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_income_mo <- renderPlotly({
    req(input$city)
    d <- income_m_m %>%
      filter(City == input$city) %>%
      mutate(month = factor(month, levels = month.abb)) %>%
      arrange(year, month)
    p <- ggplot(d, aes(interaction(year, month, lex.order = TRUE), SP, group = 1)) +
      geom_line() + geom_point() +
      num_axis() + labs(x = NULL, y = "Median SP ($)") +
      theme_minimal(base_size = 12) +
      theme(axis.text.x = element_blank())
    ggplotly(p, tooltip = c("x","y"))
  }) %>% bindCache(input$city)

  # ---- LEASES ----
  out_l <- reactive({
    req(input$city_l)
    lease_q %>% filter(CITY_KEY == input$city_l)
  }) %>% bindCache(input$city_l)

  output$p_lease_qtr <- renderPlotly({
    d <- out_l()
    p <- ggplot(d, aes(period_label, median_LP)) +
      geom_col() +
      num_axis() + labs(x = NULL, y = "Median LP ($)") +
      theme_minimal(base_size = 12) +
      theme(axis.text.x = element_text(angle = 60, hjust = 1))
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_lease_dom <- renderPlotly({
    d <- out_l()
    p <- ggplot(d, aes(period_label, median_DOM_lease)) +
      geom_col() +
      labs(x = NULL, y = "Median DOM (Lease)") +
      theme_minimal(base_size = 12) +
      theme(axis.text.x = element_text(angle = 60, hjust = 1))
    ggplotly(p, tooltip = c("x","y"))
  })

  # ---- PERMITS (BPS) ----
  out_b <- reactive({
    req(input$city_b)
    bps_ca %>% filter(City == input$city_b)
  }) %>% bindCache(input$city_b)

  output$p_bps_total <- renderPlotly({
    d <- out_b()
    p <- ggplot(d, aes(Year, Units_Total)) +
      geom_col() +
      labs(x = NULL, y = "Total Units") +
      theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_bps_5p <- renderPlotly({
    d <- out_b()
    p <- ggplot(d, aes(Year, Units_5p)) +
      geom_col() +
      labs(x = NULL, y = "5+ Units") +
      theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })

  # ---- CRIME ----
  output$crime_note <- renderUI({
    if (toupper(input$city_c) == "ONTARIO") {
      div(style = "padding:8px; background:#fff3cd; border:1px solid #ffeeba; border-radius:8px;",
          strong("Note: "), "No crime data for Ontario.")
    } else {
      HTML("")
    }
  })

  crime_city <- reactive({
    req(input$city_c)
    crime_master %>% filter(City == input$city_c)
  }) %>% bindCache(input$city_c)

  output$p_crime_total <- renderPlotly({
    if (toupper(input$city_c) == "ONTARIO") return(NULL)
    d <- crime_city() %>% group_by(data_year) %>% summarise(Total = sum(Total, na.rm = TRUE), .groups = "drop")
    validate(need(nrow(d) > 0, "No crime rows for this city/year range."))
    p <- ggplot(d, aes(data_year, Total, group = 1)) +
      geom_line() + geom_point() +
      num_axis() + labs(x = NULL, y = "Total Index Crimes") +
      theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_crime_breakout <- renderPlotly({
    if (toupper(input$city_c) == "ONTARIO") return(NULL)
    d <- crime_city() %>%
      select(data_year, Violent, Property, Homicide, Rape, Robbery, Aggravated_Assault,
             Burglary, Larceny_Theft, Motor_Vehicle_Theft, Arson) %>%
      pivot_longer(-data_year, names_to = "Metric", values_to = "Value")
    validate(need(nrow(d) > 0, "No crime rows for this city/year range."))
    p <- ggplot(d, aes(data_year, Value, color = Metric)) +
      geom_line() +
      theme_minimal(base_size = 12) + labs(x = NULL, y = NULL)
    ggplotly(p, tooltip = c("x","y","colour"))
  })

  # ---- ACS ----
  output$tbl_compare <- render_gt({
    req(input$city_a)
    nm <- NAME_MAP[[toupper(input$city_a)]]
    d <- acs_compare %>% filter(NAME == nm)
    validate(need(nrow(d) == 1, "No ACS compare row for this place."))

    gt(d %>%
         transmute(
           Place = NAME,
           `Owner % 2012`  = pct_owner_2012,  `Owner % 2022`  = pct_owner_2022,  `Δ Owner (pp)` = pp_change_owner,
           `Renter % 2012` = pct_renter_2012, `Renter % 2022` = pct_renter_2022, `Δ Renter (pp)`= pp_change_renter,
           `Under 18 % 2012` = pct_under18_2012, `Under 18 % 2022` = pct_under18_2022, `Δ Under 18 (pp)` = pp_under18,
           `18–34 % 2012`    = pct_18_34_2012,  `18–34 % 2022`    = pct_18_34_2022,  `Δ 18–34 (pp)`    = pp_18_34,
           `35–64 % 2012`    = pct_35_64_2012,  `35–64 % 2022`    = pct_35_64_2022,  `Δ 35–64 (pp)`    = pp_35_64,
           `65+ % 2012`      = pct_65plus_2012, `65+ % 2022`      = pct_65plus_2022, `Δ 65+ (pp)`      = pp_65plus,
           `Median Age 2012` = median_age_2012, `Median Age 2022` = median_age_2022, `Δ Median Age`    = pp_change_median_age
         )) %>%
      fmt_percent(columns = matches("%"), scale_values = FALSE, decimals = 1) %>%
      fmt_number(columns = matches("Median Age"), decimals = 1) %>%
      tab_options(table.font.size = px(13))
  })

  acs_city_ts <- reactive({
    req(input$city_a)
    place <- tools::toTitleCase(tolower(input$city_a))
    acs_times %>% filter(place == place)
  }) %>% bindCache(input$city_a)

  output$p_acs_vac <- renderPlotly({
    d <- acs_city_ts()
    p <- ggplot(d, aes(year, vacancy_rate_pct)) + geom_line() + geom_point() +
      labs(x = NULL, y = "Vacancy Rate (%)") + theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_acs_inc <- renderPlotly({
    d <- acs_city_ts()
    p <- ggplot(d, aes(year, median_hh_income)) + geom_line() + geom_point() +
      num_axis() + labs(x = NULL, y = "Median HH Income ($)") + theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })

  output$p_acs_pop <- renderPlotly({
    d <- acs_city_ts()
    p <- ggplot(d, aes(year, population)) + geom_line() + geom_point() +
      num_axis() + labs(x = NULL, y = "Population") + theme_minimal(base_size = 12)
    ggplotly(p, tooltip = c("x","y"))
  })
}

```




